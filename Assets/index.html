<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <meta name="color-scheme" content="light dark">
    <title>MermaidPad Preview</title>
    <style>
        /* Paint correctly on first frame based on OS theme */
        html, body { margin: 0; height: 100%; background: #fff; color: #222; }
        @media (prefers-color-scheme: dark) {
            html, body { background: #1e1e1e; color: #ddd; }
        }
        body.dark-theme { background: #1e1e1e; color: #ddd; }
        body.light-theme { background: #fff; color: #222; }
        #output { padding: 8px; overflow: auto; height: 100vh; box-sizing: border-box; }
        .error { color: #ff6f6f; white-space: pre; font-family: Consolas,monospace; }

        /* Mermaid dark theme overrides */
        body.dark-theme #output svg .messageLine,
        body.dark-theme #output svg .actor-line,
        body.dark-theme #output svg .mermaid .edgePath path,
        body.dark-theme #output svg .mermaid .node rect,
        body.dark-theme #output svg .mermaid .node circle,
        body.dark-theme #output svg .mermaid .node ellipse { stroke: #e0e0e0 !important; }
        body.dark-theme #output svg text,
        body.dark-theme #output svg .messageText { fill: #e0e0e0 !important; }
    </style>
    
    <!-- Load js-yaml first (regular script) -->
    <script src="js-yaml.min.js"></script>
    
    <!-- Load Mermaid (UMD/IIFE format) -->
    <script src="mermaid.min.js"></script>
    
    <!-- Load and register ELK layout after Mermaid is loaded -->
    <script type="module">
        // Theme helper functions
        window.getSystemTheme = () => {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').media !== 'not all') {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default';
            }
            return 'default';
        };
        
        window.applyTheme = theme => {
            document.body.classList.toggle('dark-theme', theme === 'dark');
            document.body.classList.toggle('light-theme', theme === 'default');
        };
        
        // Wait for mermaid to be available globally, then load ELK
        function initializeMermaidWithElk() {
            if (typeof window.mermaid !== 'undefined') {
                // Import the ELK layout module
                import('./mermaid-elk-layout/mermaid-layout-elk.esm.min.mjs')
                    .then(module => {
                        const elkLayouts = module.default;
                        // Register ELK layouts with Mermaid
                        window.mermaid.registerLayoutLoaders(elkLayouts);
                        console.log('ELK layout registered successfully');
                        
                        // Initialize mermaid after ELK is registered
                        const currentTheme = window.getSystemTheme();
                        window.mermaid.initialize({ 
                            startOnLoad: false, 
                            theme: currentTheme
                            // Note: defaultRenderer can be set per-diagram or via config frontmatter
                        });
                        
                        // Set flag that initialization is complete
                        window.mermaidInitialized = true;
                        
                        // Trigger any pending renders
                        if (window.pendingMermaidRender) {
                            window.renderMermaid(window.pendingMermaidRender);
                            window.pendingMermaidRender = null;
                        }
                    })
                    .catch(err => {
                        console.error('Failed to load ELK layout:', err);
                        // Fall back to standard mermaid initialization without ELK
                        const currentTheme = window.getSystemTheme();
                        window.mermaid.initialize({ 
                            startOnLoad: false, 
                            theme: currentTheme
                        });
                        window.mermaidInitialized = true;
                    });
            } else {
                // Retry if mermaid isn't loaded yet
                setTimeout(initializeMermaidWithElk, 50);
            }
        }
        
        // Start the initialization process
        initializeMermaidWithElk();
    </script>
    <script>
        let currentTheme = window.getSystemTheme ? window.getSystemTheme() : 'default';
        
        // ReSharper disable PossiblyUnassignedProperty
        document.addEventListener('DOMContentLoaded', () => {
            if (window.applyTheme) {
                window.applyTheme(currentTheme);
            }
            
            // Listen for theme changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    currentTheme = e.matches ? 'dark' : 'default';
                    if (window.applyTheme) {
                        window.applyTheme(currentTheme);
                    }
                    // Re-render with new theme
                    if (window.lastMermaidSource) {
                        // Re-initialize mermaid with new theme before rendering
                        if (window.mermaid && window.mermaidInitialized) {
                            // Extract config from the source if present
                            const fmRegex = /^---\s*([\s\S]*?)---\s*/;
                            const match = window.lastMermaidSource.match(fmRegex);
                            let config = { startOnLoad: false, theme: currentTheme };
                            
                            if (match) {
                                try {
                                    const parsed = window.jsyaml.load(match[1]);
                                    if (parsed && parsed.config) {
                                        config = { ...config, ...parsed.config, theme: currentTheme };
                                    }
                                } catch (err) {
                                    // Keep default config if parsing fails
                                }
                            }
                            
                            window.mermaid.initialize(config);
                        }
                        window.renderMermaid(window.lastMermaidSource);
                    }
                });
            }
        });
        // ReSharper enable PossiblyUnassignedProperty

        window.renderMermaid = source => {
            window.lastMermaidSource = source; // Save for re-rendering on theme change
            const output = document.getElementById('output');

            // Helper functions for safe DOM manipulation
            const createErrorElement = (message) => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message; // XSS-safe
                return errorDiv;
            };

            const showError = (message) => {
                output.innerHTML = '';
                output.appendChild(createErrorElement(message));
            };

            const setSafeSVG = (htmlContent) => {
                // Validate SVG content structure
                const trimmed = htmlContent.trim();
                if (trimmed.startsWith('<svg') && trimmed.includes('</svg>')) {
                    output.innerHTML = htmlContent;
                } else {
                    showError('Invalid diagram content received');
                }
            };

            // Check if mermaid is initialized with ELK support
            if (!window.mermaidInitialized) {
                // Store the source to render after initialization
                window.pendingMermaidRender = source;
                
                // Check if mermaid is at least available
                if (!window.mermaid) {
                    // Retry a few times before showing error
                    const retryLimit = 20;
                    let retries = window._mermaidRetries || 0;
                    if (retries < retryLimit) {
                        window._mermaidRetries = retries + 1;
                        setTimeout(() => window.renderMermaid(source), 100);
                        return;
                    }
                    showError('Mermaid library is not loaded.'); // XSS-safe
                    return;
                }
                // If mermaid exists but not initialized, wait a bit more
                setTimeout(() => window.renderMermaid(source), 100);
                return;
            }
            window._mermaidRetries = 0;

            // STEP 1: Check for config
            const fmRegex = /^---\s*([\s\S]*?)---\s*/;
            let diagramSource = source;
            const match = source.match(fmRegex);
            let configToApply = null;

            if (match) {
                try {
                    // STEP 2: Parsing config
                    const parsed = window.jsyaml.load(match[1]);
                    if (parsed && parsed.config) {
                        configToApply = parsed.config;
                        // Apply config with current theme
                        window.mermaid.initialize({ 
                            ...configToApply, 
                            theme: configToApply.theme || currentTheme,
                            startOnLoad: false 
                        });
                    }
                    // STEP 3: Get rest of the source
                    diagramSource = source.replace(fmRegex, "");
                } catch (err) {
                    showError(`YAML parse error: ${err.message}`); // XSS-safe
                    return;
                }
            }

            // STEP 4: Render with clean diagram source
            const id = `mermaid-svg-${Date.now()}`;
            window.mermaid.render(id, diagramSource)
                .then(result => {
                    setSafeSVG(result.svg); // Validated SVG insertion
                    if (typeof result.bindFunctions === 'function') {
                        result.bindFunctions(output);
                    }
                })
                .catch(e => {
                    showError(e.message); // XSS-safe
                });
        };

        window.clearOutput = () => {
            document.getElementById('output').innerHTML = '';
        };
    </script>
</head>
<body>
    <div id="output">Click 'Render' or 'Enable Live Preview'</div>
</body>
</html>
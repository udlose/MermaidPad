<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>MermaidPad Preview</title>
    <style>
        body.dark-theme { background: #1e1e1e; color: #ddd; }
        body.light-theme { background: #fff; color: #222; }
        #output { padding:8px; overflow:auto; height:100vh; box-sizing:border-box; }
        .error { color:#ff6f6f; white-space:pre; font-family:Consolas,monospace; }
    </style>
    <script src="mermaid.min.js" defer></script>
    <script>
        const getSystemTheme = () => {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').media !== 'not all') {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default';
            }
            return 'default';
        };

        const applyTheme = theme => {
            document.body.classList.toggle('dark-theme', theme === 'dark');
            document.body.classList.toggle('light-theme', theme === 'default');
        };

        let currentTheme = getSystemTheme();

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme);

            if (window.mermaid) {
                mermaid.initialize({ startOnLoad: false, theme: currentTheme });
        }

            // Listen for theme changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    currentTheme = e.matches ? 'dark' : 'default';
                    applyTheme(currentTheme);
                    if (window.lastMermaidSource) {
                        window.renderMermaid(window.lastMermaidSource);
                    }
                });
            }
        });

        window.renderMermaid = source => {
            window.lastMermaidSource = source; // Save for re-rendering on theme change
            const output = document.getElementById('output');
            if (!window.mermaid) {
                output.innerHTML = '<div class="error">Mermaid library is not loaded.</div>';
                return;
            }
            const id = `mermaid-svg-${Date.now()}`;
            mermaid.render(id, source)
                .then(result => {
                    output.innerHTML = result.svg;
                    if (typeof result.bindFunctions === 'function') {
                        result.bindFunctions(output);
                    }
                })
                .catch(e => {
                    output.innerHTML = `<div class="error">${e.message}</div>`;
                });
        };

        window.clearOutput = () => {
            document.getElementById('output').innerHTML = '';
        };
    </script>
</head>
<body>
    <div id="output">Click 'Render' or 'Enable Live Preview'</div>
</body>
</html>
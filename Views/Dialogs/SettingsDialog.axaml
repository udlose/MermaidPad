<Window
  x:Class="MermaidPad.Views.Dialogs.SettingsDialog"
  xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:vm="clr-namespace:MermaidPad.ViewModels.Dialogs"
  xmlns:ai="clr-namespace:MermaidPad.Models.AI"
  Title="Settings"
  Width="600"
  Height="550"
  d:DesignHeight="550"
  d:DesignWidth="600"
  x:DataType="vm:SettingsDialogViewModel"
  CanResize="False"
  ShowInTaskbar="False"
  WindowStartupLocation="CenterOwner"
  mc:Ignorable="d">

  <Window.Styles>
    <Style Selector="TextBlock.SectionHeader">
      <Setter Property="FontWeight" Value="Bold" />
      <Setter Property="Margin" Value="0,10,0,5" />
      <Setter Property="FontSize" Value="14" />
    </Style>

    <Style Selector="Border.SectionBorder">
      <Setter Property="BorderBrush" Value="#E0E0E0" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="10" />
      <Setter Property="Margin" Value="0,5,0,10" />
    </Style>

    <Style Selector="StackPanel.OptionRow">
      <Setter Property="Orientation" Value="Horizontal" />
      <Setter Property="Margin" Value="0,5" />
      <Setter Property="Spacing" Value="10" />
    </Style>

    <Style Selector="TextBlock.OptionLabel">
      <Setter Property="Width" Value="120" />
      <Setter Property="VerticalAlignment" Value="Center" />
    </Style>

    <Style Selector="Border.SuccessMessage">
      <Setter Property="Background" Value="#E8F5E9" />
      <Setter Property="BorderBrush" Value="#4CAF50" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="10" />
    </Style>

    <Style Selector="Border.ErrorMessage">
      <Setter Property="Background" Value="#FFEBEE" />
      <Setter Property="BorderBrush" Value="#F44336" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="CornerRadius" Value="4" />
      <Setter Property="Padding" Value="10" />
    </Style>
  </Window.Styles>

  <Grid Margin="20" RowDefinitions="Auto,*,Auto">

    <!--  Header  -->
    <StackPanel Grid.Row="0">
      <TextBlock
        Margin="0,0,0,10"
        FontSize="18"
        FontWeight="Bold"
        Text="Settings" />

      <TextBlock
        Margin="0,0,0,20"
        Foreground="#666666"
        Text="Configure AI features and preferences" />
    </StackPanel>

    <!--  Main Content  -->
    <ScrollViewer
      Grid.Row="1"
      HorizontalScrollBarVisibility="Disabled"
      VerticalScrollBarVisibility="Auto">
      <StackPanel>
        <!--  AI Features  -->
        <TextBlock Classes="SectionHeader" Text="AI Features" />
        <Border Classes="SectionBorder">
          <StackPanel>
            <!--  Enable AI  -->
            <CheckBox
              Content="Enable AI Features"
              IsChecked="{Binding EnableAIFeatures}"
              Margin="0,0,0,10" />

            <StackPanel IsEnabled="{Binding EnableAIFeatures}">
              <!--  Provider Selection  -->
              <StackPanel Classes="OptionRow">
                <TextBlock Classes="OptionLabel" Text="AI Provider:" />
                <ComboBox
                  Width="350"
                  ItemsSource="{Binding AvailableProviders}"
                  SelectedItem="{Binding SelectedProvider}" />
              </StackPanel>

              <!--  API Key  -->
              <StackPanel Classes="OptionRow" IsVisible="{Binding SelectedProvider, Converter={StaticResource IsNotEqualConverter}, ConverterParameter={x:Static ai:AIProvider.None}}">
                <TextBlock Classes="OptionLabel" Text="API Key:" />
                <TextBox
                  Width="280"
                  PasswordChar="{Binding ShowApiKey, Converter={StaticResource InverseBoolToObjectConverter}, ConverterParameter='•'}"
                  Text="{Binding ApiKey}"
                  Watermark="Enter your API key" />
                <Button
                  Width="60"
                  Command="{Binding ToggleApiKeyVisibilityCommand}"
                  Content="{Binding ShowApiKey, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Hide|Show'}" />
              </StackPanel>

              <!--  Model Selection  -->
              <StackPanel Classes="OptionRow" IsVisible="{Binding SelectedProvider, Converter={StaticResource IsEqualConverter}, ConverterParameter={x:Static ai:AIProvider.Anthropic}}">
                <TextBlock Classes="OptionLabel" Text="Model:" />
                <ComboBox
                  Width="350"
                  ItemsSource="{Binding AnthropicModels}"
                  SelectedItem="{Binding Model}" />
              </StackPanel>

              <!--  Test Connection  -->
              <StackPanel Classes="OptionRow" IsVisible="{Binding SelectedProvider, Converter={StaticResource IsNotEqualConverter}, ConverterParameter={x:Static ai:AIProvider.None}}">
                <TextBlock Classes="OptionLabel" Text="" />
                <Button
                  Width="150"
                  Command="{Binding TestConnectionCommand}"
                  Content="{Binding IsTestingConnection, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Testing...|Test Connection'}"
                  IsEnabled="{Binding !IsTestingConnection}" />
              </StackPanel>

              <!--  Test Result  -->
              <Border
                Margin="130,5,0,10"
                Classes.ErrorMessage="{Binding !TestConnectionSuccess}"
                Classes.SuccessMessage="{Binding TestConnectionSuccess}"
                IsVisible="{Binding TestConnectionResult, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                <TextBlock Text="{Binding TestConnectionResult}" TextWrapping="Wrap" />
              </Border>

              <!--  Privacy Notice  -->
              <Border
                Margin="0,10,0,10"
                Background="#E3F2FD"
                BorderBrush="#2196F3"
                BorderThickness="1"
                CornerRadius="4"
                Padding="10">
                <StackPanel>
                  <TextBlock FontWeight="SemiBold" Text="ℹ️ Privacy Notice" />
                  <TextBlock
                    Margin="0,5,0,0"
                    Foreground="#555555"
                    Text="Your API key is stored securely using platform-specific encryption and never leaves your device. Diagram content is sent to your chosen AI provider only when you use AI features."
                    TextWrapping="Wrap" />
                </StackPanel>
              </Border>
            </StackPanel>
          </StackPanel>
        </Border>

        <!--  Feature Toggles  -->
        <TextBlock Classes="SectionHeader" Text="Available Features" />
        <Border Classes="SectionBorder">
          <StackPanel IsEnabled="{Binding EnableAIFeatures}" Spacing="8">
            <CheckBox
              Content="Natural language to diagram generation"
              IsChecked="{Binding EnableNaturalLanguageGeneration}" />
            <CheckBox
              Content="Diagram explanation"
              IsChecked="{Binding EnableDiagramExplanation}" />
            <CheckBox
              Content="Smart suggestions and improvements"
              IsChecked="{Binding EnableSmartSuggestions}" />
          </StackPanel>
        </Border>
      </StackPanel>
    </ScrollViewer>

    <!--  Buttons  -->
    <StackPanel
      Grid.Row="2"
      Margin="0,20,0,0"
      HorizontalAlignment="Right"
      Orientation="Horizontal"
      Spacing="10">
      <Button
        Width="100"
        Click="OnSaveClick"
        Content="Save"
        IsDefault="True" />
      <Button
        Width="100"
        Click="OnCancelClick"
        Content="Cancel"
        IsCancel="True" />
    </StackPanel>
  </Grid>
</Window>

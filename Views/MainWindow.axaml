<Window
  x:Class="MermaidPad.Views.MainWindow"
  xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:edit="clr-namespace:AvaloniaEdit;assembly=AvaloniaEdit"
  xmlns:vm="clr-namespace:MermaidPad.ViewModels"
  xmlns:views="clr-namespace:MermaidPad.Views"
  xmlns:wv="clr-namespace:AvaloniaWebView;assembly=Avalonia.WebView"
  xmlns:converters="clr-namespace:MermaidPad.Converters"
  Title="{Binding WindowTitle}"
  Width="1200"
  Height="800"
  x:DataType="vm:MainViewModel"
  Icon="/Assets/AppIcon.ico">

  <Window.Resources>
    <converters:BoolToTooltipConverter x:Key="BoolToTooltipConverter" />
  </Window.Resources>

  <Window.Styles>
    <Style Selector="edit|TextEditor ScrollBar[Orientation=Vertical]">
      <Setter Property="Width" Value="15" />
    </Style>

    <Style Selector="edit|TextEditor ScrollBar[Orientation=Horizontal]">
      <Setter Property="Height" Value="15" />
    </Style>
  </Window.Styles>

  <DockPanel>
    <!-- Menu Bar -->
    <Menu DockPanel.Dock="Top">
      <MenuItem Header="_File">
        <MenuItem
          Command="{Binding OpenFileCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="_Open..."
          InputGesture="Ctrl+O" />
        <MenuItem
          Command="{Binding SaveFileCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="_Save"
          InputGesture="Ctrl+S"
          IsEnabled="{Binding CanSave}" />
        <MenuItem
          Command="{Binding SaveFileAsCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="Save _As..."
          InputGesture="Ctrl+Shift+S"
          IsEnabled="{Binding HasText}" />
        <Separator />
        <MenuItem
          Click="OnExitClick"
          Header="E_xit"
          InputGesture="Alt+F4" />
      </MenuItem>
    </Menu>

    <!-- Toolbar -->
    <StackPanel
      Margin="6"
      DockPanel.Dock="Top"
      Orientation="Horizontal"
      Spacing="6">
      <Button
        Width="90"
        Command="{Binding RenderCommand}"
        Content="Render"
        ToolTip.Tip="{Binding !IsWebViewReady, Converter={StaticResource BoolToTooltipConverter}}" />
      <Button
        Command="{Binding ClearCommand}"
        Content="Clear"
        ToolTip.Tip="{Binding !IsWebViewReady, Converter={StaticResource BoolToTooltipConverter}}" />
      <Button
        Command="{Binding ExportCommand}"
        Content="Export"
        ToolTip.Tip="{Binding !IsWebViewReady, Converter={StaticResource BoolToTooltipConverter}}" />
      <Separator Margin="6,0" />
      <Button
        Command="{Binding OpenSettingsCommand}"
        Content="Settings"
        ToolTip.Tip="Configure AI settings" />
      <Separator Margin="6,0" />
      <CheckBox
        Margin="6,0,0,0"
        Content="Live Preview:"
        FlowDirection="RightToLeft"
        IsChecked="{Binding LivePreviewEnabled}"
        IsEnabled="{Binding IsWebViewReady}"
        ToolTip.Tip="{Binding !IsWebViewReady, Converter={StaticResource BoolToTooltipConverter}}" />
      <TextBlock
        Margin="12,0,0,0"
        HorizontalAlignment="Right"
        VerticalAlignment="Center"
        Text="Version:" />
      <TextBlock
        HorizontalAlignment="Right"
        VerticalAlignment="Center"
        Text="{Binding CurrentMermaidPadVersion}" />
      <TextBlock
        Margin="12,0,0,0"
        VerticalAlignment="Center"
        Foreground="Gray"
        Text="{Binding StatusText}" />
    </StackPanel>

    <!-- Main Content with 3 flexible columns for dockable panels -->
    <Grid DockPanel.Dock="Top" x:Name="MainContentGrid">
      <Grid.ColumnDefinitions>
        <!-- Column 1 -->
        <ColumnDefinition Width="*" MinWidth="250" />
        <ColumnDefinition Width="Auto" />
        <!-- Column 2 -->
        <ColumnDefinition Width="2*" MinWidth="250" />
        <ColumnDefinition Width="Auto" />
        <!-- Column 3 -->
        <ColumnDefinition Width="*" MinWidth="250" />
      </Grid.ColumnDefinitions>

      <!-- Column 1 Splitter -->
      <GridSplitter
        Grid.Column="1"
        Width="6"
        Background="Transparent"
        ResizeDirection="Columns" />

      <!-- Column 2 Splitter -->
      <GridSplitter
        Grid.Column="3"
        Width="6"
        Background="Transparent"
        ResizeDirection="Columns" />

      <!-- Editor Panel (positioned dynamically by code-behind) -->
      <Border
        x:Name="EditorBorder"
        Grid.Column="0"
        Margin="6,0,0,6"
        BorderBrush="LightGray"
        BorderThickness="1"
        CornerRadius="4">
        <DockPanel>
          <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8,6">
            <TextBlock FontWeight="Bold" Text="Editor" VerticalAlignment="Center" />
            <Button
              Content="←"
              Margin="8,0,2,0"
              Padding="4,2"
              ToolTip.Tip="Move panel left"
              x:Name="EditorMoveLeftButton" />
            <Button
              Content="→"
              Padding="4,2"
              ToolTip.Tip="Move panel right"
              x:Name="EditorMoveRightButton" />
          </StackPanel>
          <edit:TextEditor
            x:Name="Editor"
            FontFamily="Consolas"
            HorizontalScrollBarVisibility="Auto"
            LineNumbersForeground="Lime"
            ShowLineNumbers="True"
            VerticalScrollBarVisibility="Auto">
            <edit:TextEditor.ContextMenu>
              <ContextMenu Opening="GetContextMenuState">
                <MenuItem
                  Header="Copy"
                  IsEnabled="{Binding CanCopyClipboard}"/>
                <MenuItem
                  Header="Paste"
                  IsEnabled="{Binding CanPasteClipboard}"/>
              </ContextMenu>
            </edit:TextEditor.ContextMenu>
          </edit:TextEditor>
        </DockPanel>
      </Border>

      <!-- Preview Panel (positioned dynamically by code-behind) -->
      <Border
        x:Name="PreviewBorder"
        Grid.Column="2"
        Margin="0,0,0,6"
        BorderBrush="LightGray"
        BorderThickness="1"
        CornerRadius="4">
        <DockPanel>
          <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8,6">
            <TextBlock FontWeight="Bold" Text="Preview" VerticalAlignment="Center" />
            <Button
              Content="←"
              Margin="8,0,2,0"
              Padding="4,2"
              ToolTip.Tip="Move panel left"
              x:Name="PreviewMoveLeftButton" />
            <Button
              Content="→"
              Padding="4,2"
              ToolTip.Tip="Move panel right"
              x:Name="PreviewMoveRightButton" />
          </StackPanel>
          <Grid>
            <wv:WebView Name="Preview" />
            <TextBlock
              Margin="10"
              HorizontalAlignment="Left"
              VerticalAlignment="Top"
              FontSize="11"
              Foreground="Red"
              IsVisible="{Binding LastError, Converter={x:Static ObjectConverters.IsNotNull}}"
              Text="{Binding LastError}"
              TextWrapping="Wrap" />
          </Grid>
        </DockPanel>
      </Border>

      <!-- AI Assistant Panel (positioned dynamically by code-behind) -->
      <Border
        x:Name="AIBorder"
        Grid.Column="4"
        Margin="0,0,6,6"
        BorderBrush="LightGray"
        BorderThickness="1"
        CornerRadius="4">
        <DockPanel>
          <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8,6">
            <TextBlock FontWeight="Bold" Text="AI Assistant" VerticalAlignment="Center" />
            <Button
              Content="←"
              Margin="8,0,2,0"
              Padding="4,2"
              ToolTip.Tip="Move panel left"
              x:Name="AIMoveLeftButton" />
            <Button
              Content="→"
              Padding="4,2"
              ToolTip.Tip="Move panel right"
              x:Name="AIMoveRightButton" />
          </StackPanel>
          <views:AIPanel DataContext="{Binding AIPanelViewModel}" />
        </DockPanel>
      </Border>
    </Grid>
  </DockPanel>
</Window>

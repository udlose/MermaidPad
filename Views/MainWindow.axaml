<Window
  x:Class="MermaidPad.Views.MainWindow"
  xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:idc="clr-namespace:Dock.Avalonia.Controls;assembly=Dock.Avalonia"
  xmlns:local="clr-namespace:MermaidPad"
  xmlns:vm="clr-namespace:MermaidPad.ViewModels"
  Name="Main"
  Title="{Binding WindowTitle}"
  Width="1200"
  Height="800"
  x:DataType="vm:MainWindowViewModel"
  Icon="/Assets/AppIcon.ico">

  <!--  KeyBindings: Makes keyboard shortcuts actually work (not just display)  -->
  <!--  InputGesture on MenuItem only shows the shortcut text - it doesn't work!  -->
  <!--  These KeyBindings register the actual functional keyboard shortcuts.  -->
  <Window.KeyBindings>
    <!--  File Menu Shortcuts  -->
    <KeyBinding
      Command="{Binding NewFileCommand}"
      CommandParameter="{Binding #Main.StorageProvider}"
      Gesture="Ctrl+N" />
    <KeyBinding
      Command="{Binding OpenFileCommand}"
      CommandParameter="{Binding #Main.StorageProvider}"
      Gesture="Ctrl+O" />
    <KeyBinding
      Command="{Binding SaveFileCommand}"
      CommandParameter="{Binding #Main.StorageProvider}"
      Gesture="Ctrl+S" />
    <KeyBinding
      Command="{Binding SaveFileAsCommand}"
      CommandParameter="{Binding #Main.StorageProvider}"
      Gesture="Ctrl+Shift+S" />
    <KeyBinding
      Command="{Binding CloseFileCommand}"
      CommandParameter="{Binding #Main.StorageProvider}"
      Gesture="Ctrl+W" />
  </Window.KeyBindings>

  <!--
    NOTE: DataTemplates for Dock Tool Views are defined in App.axaml at the Application level.
    This ensures they are available to floating windows (HostWindow) which have a separate visual tree.
  -->

  <DockPanel>
    <!--  Menu Bar  -->
    <Menu DockPanel.Dock="Top">
      <MenuItem Header="_File">
        <!--  New File  -->
        <MenuItem
          Command="{Binding NewFileCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="_New"
          InputGesture="Ctrl+N" />
        <!--  Open File  -->
        <MenuItem
          Command="{Binding OpenFileCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="_Open..."
          InputGesture="Ctrl+O" />
        <!--  Save File  -->
        <MenuItem
          Command="{Binding SaveFileCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="_Save"
          InputGesture="Ctrl+S" />
        <!--  Save As  -->
        <MenuItem
          Command="{Binding SaveFileAsCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="Save _As..."
          InputGesture="Ctrl+Shift+S" />
        <!--  Close File  -->
        <MenuItem
          Command="{Binding CloseFileCommand}"
          CommandParameter="{Binding StorageProvider, RelativeSource={RelativeSource AncestorType=TopLevel}}"
          Header="_Close"
          InputGesture="Ctrl+W" />
        <Separator />
        <!--  Recent Files Submenu  -->
        <!--
          Uses ItemContainerTheme to properly bind each generated MenuItem to RecentFileItem properties.
          This solves the Avalonia limitation where nested menu items can't easily bind to parent ViewModel commands.
          Each RecentFileItem contains: FilePath, FileName, and OpenCommand reference.
        -->
        <MenuItem
          Header="_Recent Files"
          IsEnabled="{Binding HasRecentFiles}"
          ItemsSource="{Binding RecentFiles}">
          <MenuItem.ItemContainerTheme>
            <ControlTheme BasedOn="{StaticResource {x:Type MenuItem}}" TargetType="MenuItem">
              <!--
                Use ReflectionBinding (not compiled binding) because ItemContainerTheme Setters
                resolve against the item's DataContext (RecentFileItem) at runtime, not the Window's DataType
              -->
              <Setter Property="Header" Value="{ReflectionBinding FileName}" />
              <Setter Property="Command" Value="{ReflectionBinding OpenCommand}" />
              <Setter Property="CommandParameter" Value="{ReflectionBinding FilePath}" />
              <Setter Property="ToolTip.Tip" Value="{ReflectionBinding FilePath}" />
            </ControlTheme>
          </MenuItem.ItemContainerTheme>
        </MenuItem>
        <!--  Clear Recent Files  -->
        <MenuItem Command="{Binding ClearRecentFilesCommand}" Header="C_lear Recent Files" />
        <Separator />
        <!--  Exit  -->
        <MenuItem
          Click="OnExitClick"
          Header="E_xit"
          InputGesture="Alt+F4" />
      </MenuItem>
      <MenuItem Header="_Edit">
        <MenuItem
          Command="{Binding Editor.CutCommand}"
          Header="Cu_t"
          InputGesture="Ctrl+X" />
        <MenuItem
          Command="{Binding Editor.CopyCommand}"
          Header="_Copy"
          InputGesture="Ctrl+C" />
        <MenuItem
          Command="{Binding Editor.PasteCommand}"
          Header="_Paste"
          InputGesture="Ctrl+V" />
        <Separator />
        <MenuItem
          Command="{Binding Editor.UndoCommand}"
          Header="_Undo"
          InputGesture="Ctrl+Z" />
        <MenuItem
          Command="{Binding Editor.RedoCommand}"
          Header="_Redo"
          InputGesture="Ctrl+Y" />
        <Separator />
        <MenuItem
          Command="{Binding Editor.SelectAllCommand}"
          Header="Select _All"
          InputGesture="Ctrl+A" />
        <Separator />
        <MenuItem
          Command="{Binding Editor.OpenFindCommand}"
          Header="_Find..."
          InputGesture="Ctrl+F" />
        <MenuItem
          Command="{Binding Editor.FindNextCommand}"
          Header="Find _Next"
          InputGesture="F3" />
        <MenuItem
          Command="{Binding Editor.FindPreviousCommand}"
          Header="Find Pre_vious"
          InputGesture="Shift+F3" />
        <Separator />
        <MenuItem
          Command="{Binding Editor.CommentSelectionCommand}"
          Header="_Comment Selection"
          InputGesture="Ctrl+Shift+C" />
        <MenuItem
          Command="{Binding Editor.UncommentSelectionCommand}"
          Header="_Uncomment Selection"
          InputGesture="Ctrl+Shift+U" />
        <Separator />
        <MenuItem Header="Editor Settings">
          <MenuItem
            Header="Enable _Rectangular Selection"
            IsChecked="{Binding Editor.EnableRectangularSelection, Mode=TwoWay}"
            ToggleType="CheckBox" />
          <MenuItem
            Header="Enable Text _Drag/Drop"
            IsChecked="{Binding Editor.EnableTextDragDrop, Mode=TwoWay}"
            ToggleType="CheckBox" />
          <MenuItem
            Header="Hide Cursor While _Typing"
            IsChecked="{Binding Editor.HideCursorWhileTyping, Mode=TwoWay}"
            ToggleType="CheckBox" />
          <MenuItem
            Header="Highlight Current _Line"
            IsChecked="{Binding Editor.HighlightCurrentLine, Mode=TwoWay}"
            ToggleType="CheckBox" />
          <MenuItem
            Header="Show Column R_ulers"
            IsChecked="{Binding Editor.ShowColumnRulers, Mode=TwoWay}"
            ToggleType="CheckBox" />
          <MenuItem
            Header="Show Line _Numbers"
            IsChecked="{Binding Editor.ShowLineNumbers, Mode=TwoWay}"
            ToggleType="CheckBox" />
          <MenuItem
            Header="Show _Spaces"
            IsChecked="{Binding Editor.ShowSpaces, Mode=TwoWay}"
            ToggleType="CheckBox" />
          <MenuItem
            Header="Word _Wrap"
            IsChecked="{Binding Editor.IsWordWrapEnabled, Mode=TwoWay}"
            ToggleType="CheckBox" />
        </MenuItem>
      </MenuItem>
      <MenuItem Name="ViewMenu" Header="_View">
        <MenuItem Command="{Binding ShowEditorPanelCommand}" Header="Show _Editor Panel" />
        <MenuItem Command="{Binding ShowDiagramPanelCommand}" Header="Show _Diagram Panel" />
        <Separator />
        <MenuItem Command="{Binding ResetLayoutCommand}" Header="_Reset Layout to Default" />
        <!--  DEBUG ONLY: Menu item added dynamically. Dump dock diagnostics to log file. Command only exists in DEBUG builds.  -->
      </MenuItem>
      <MenuItem Header="_Help">
        <MenuItem Command="{Binding ViewLogsCommand}" Header="View _Logs" />
      </MenuItem>
    </Menu>

    <!--  Toolbar  -->
    <StackPanel
      Margin="6"
      DockPanel.Dock="Top"
      Orientation="Horizontal"
      Spacing="6">
      <Button
        Width="90"
        Command="{Binding RenderCommand}"
        Content="Render"
        ToolTip.Tip="Render Diagram" />
      <Button
        Command="{Binding ClearCommand}"
        Content="Clear"
        ToolTip.Tip="Clear All (Source + Diagram)" />
      <Button
        Command="{Binding ExportCommand}"
        Content="Export"
        ToolTip.Tip="Export Diagram" />
      <CheckBox
        Margin="12,0,0,0"
        Content="Live Preview:"
        FlowDirection="RightToLeft"
        IsChecked="{Binding LivePreviewEnabled}"
        IsEnabled="{Binding Diagram.IsReady}"
        ToolTip.Tip="Toggle Live Preview" />
    </StackPanel>

    <!--  Status Bar  -->
    <DockPanel
      Name="StatusBar"
      Margin="5,0,5,5"
      DockPanel.Dock="Bottom">
      <Grid ColumnDefinitions="*,Auto">
        <!--  Left side - File status with clickable link when file is open  -->
        <!--  Single Button with conditional styling: disabled=plain text, enabled=link with underline  -->
        <Button
          Grid.Column="0"
          Padding="0"
          HorizontalAlignment="Left"
          Background="Transparent"
          BorderBrush="{x:Null}"
          BorderThickness="0"
          Command="{Binding OpenFileLocationCommand}"
          ToolTip.Tip="{Binding CurrentFilePath}">
          <Button.Styles>
            <!--  When disabled (no file): plain text appearance  -->
            <Style Selector="Button:disabled">
              <Setter Property="Cursor" Value="Arrow" />
            </Style>
            <!--  When enabled (has file): link appearance  -->
            <Style Selector="Button:not(:disabled)">
              <Setter Property="Cursor" Value="Hand" />
            </Style>
          </Button.Styles>
          <!--  Single StatusText binding - styled conditionally based on button state  -->
          <TextBlock
            FontWeight="Bold"
            Text="{Binding StatusText}"
            TextTrimming="CharacterEllipsis">
            <TextBlock.Styles>
              <!--  Default (disabled): gray text, no underline  -->
              <Style Selector="TextBlock">
                <Setter Property="Foreground" Value="Gray" />
              </Style>
              <!--  When parent button is enabled: link appearance (accent color + underline)  -->
              <Style Selector="Button:not(:disabled) > TextBlock">
                <Setter Property="Foreground" Value="{DynamicResource SystemAccentColor}" />
                <Setter Property="TextDecorations" Value="Underline" />
              </Style>
            </TextBlock.Styles>
          </TextBlock>
        </Button>

        <!--  Right side  -->
        <StackPanel
          Grid.Column="1"
          HorizontalAlignment="Right"
          Orientation="Horizontal">
          <TextBlock FontWeight="Bold" Text="Version:" />
          <TextBlock
            Margin="5,0,0,0"
            FontWeight="Bold"
            Text="{Binding Source={x:Static local:AppMetadata.FileVersion}, Mode=OneTime}" />

        </StackPanel>
      </Grid>
    </DockPanel>

    <!--
      Main Content: DockControl with dockable panels.
      
      InitializeFactory and InitializeLayout are set to False because:
      1. We manage layout creation/restoration ourselves in MainWindowViewModel.InitializeDockLayout()
      2. Our DockFactory.InitLayout() configures the locators (DockableLocator, ContextLocator, HostWindowLocator)
      3. Setting these to True would cause DockControl to override our locator configuration
      
      The layout is bound to MainWindowViewModel.Layout which is set during VM construction.
    -->
    <idc:DockControl
      x:Name="DockControl"
      Margin="6,0,6,6"
      Background="Transparent"
      Factory="{Binding DockFactory}"
      InitializeFactory="False"
      InitializeLayout="False"
      Layout="{Binding Layout}" />
  </DockPanel>
</Window>

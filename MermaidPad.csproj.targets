<Project>
	<!-- Import Directory.Build.targets if it exists -->
	<Import Project="Directory.Build.targets" Condition="Exists('Directory.Build.targets')" />

	<PropertyGroup>
		<!-- Directory under project for repo-root generated artifacts -->
		<AssetHashesDir>Generated</AssetHashesDir>

		<!-- obj/.../Generated (IntermediateOutputPath may contain RID subfolders) -->
		<GeneratedObjDir>$([System.IO.Path]::Combine('$(IntermediateOutputPath)', '$(AssetHashesDir)'))</GeneratedObjDir>

		<!-- {repo-root}/Generated -->
		<GeneratedRepoDir>$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(AssetHashesDir)'))</GeneratedRepoDir>

		<!-- Full file paths -->
		<AssetHashFileName>AssetHashes.cs</AssetHashFileName>
		<AssetHashesFile>$([System.IO.Path]::Combine('$(GeneratedObjDir)', '$(AssetHashFileName)'))</AssetHashesFile>
		<AssetHashesTempFile>$(AssetHashesFile).tmp</AssetHashesTempFile>

		<!-- Repo-root file paths (only used for cleaning explicit filenames) -->
		<AssetHashesFileRepoPath>$([System.IO.Path]::Combine('$(GeneratedRepoDir)', '$(AssetHashFileName)'))</AssetHashesFileRepoPath>
	</PropertyGroup>

	<!-- Generate asset hashes at build time for integrity verification -->
	<!-- Run before CoreCompile so generated file is available to the compiler -->
	<Target Name="GenerateAssetHashes" BeforeTargets="CoreCompile">
		<!-- Ensure target folder exists -->
		<MakeDir Directories="$(GeneratedObjDir)" />

		<!-- Calculate SHA256 for each asset file -->
		<GetFileHash Files="$(MSBuildProjectDirectory)/Assets/index.html" Algorithm="SHA256">
			<Output TaskParameter="Hash" PropertyName="IndexHtmlHash" />
		</GetFileHash>
		<GetFileHash Files="$(MSBuildProjectDirectory)/Assets/mermaid.min.js" Algorithm="SHA256">
			<Output TaskParameter="Hash" PropertyName="MermaidJsHash" />
		</GetFileHash>
		<GetFileHash Files="$(MSBuildProjectDirectory)/Assets/js-yaml.min.js" Algorithm="SHA256">
			<Output TaskParameter="Hash" PropertyName="JsYamlHash" />
		</GetFileHash>
		<GetFileHash Files="$(MSBuildProjectDirectory)/Assets/mermaid-elk-layout/mermaid-layout-elk.esm.min.mjs" Algorithm="SHA256">
			<Output TaskParameter="Hash" PropertyName="MermaidElkLayoutHash" />
		</GetFileHash>
		<GetFileHash Files="$(MSBuildProjectDirectory)/Assets/mermaid-elk-layout/chunks/mermaid-layout-elk.esm.min/chunk-SP2CHFBE.mjs" Algorithm="SHA256">
			<Output TaskParameter="Hash" PropertyName="MermaidElkLayoutChunkSP2CHFBEHash" />
		</GetFileHash>
		<GetFileHash Files="$(MSBuildProjectDirectory)/Assets/mermaid-elk-layout/chunks/mermaid-layout-elk.esm.min/render-AVRWSH4D.mjs" Algorithm="SHA256">
			<Output TaskParameter="Hash" PropertyName="MermaidElkLayoutChunkRenderAVRWSH4DHash" />
		</GetFileHash>

		<Message Importance="High" Text="Index.html Hash: $(IndexHtmlHash)" />
		<Message Importance="High" Text="Mermaid.min.js Hash: $(MermaidJsHash)" />
		<Message Importance="High" Text="Js-YAML.min.js Hash: $(JsYamlHash)" />
		<Message Importance="High" Text="Mermaid-ELK-Layout Hash: $(MermaidElkLayoutHash)" />
		<Message Importance="High" Text="Mermaid-ELK-Layout Chunk-SP2CHFBE Hash: $(MermaidElkLayoutChunkSP2CHFBEHash)" />
		<Message Importance="High" Text="Mermaid-ELK-Layout Chunk-Render-AVRWSH4D Hash: $(MermaidElkLayoutChunkRenderAVRWSH4DHash)" />

		<!-- Put the entire generated file text into an item metadata value to preserve semicolons and angle brackets -->
		<ItemGroup>
			<AssetHashFile Include="AssetHashes.cs">
				<Text>
					<![CDATA[// MIT License
// Copyright (c) 2025 Dave Black
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

using System;
using System.Collections.Frozen;
using System.Collections.Generic;

namespace MermaidPad.Generated;

/// <summary>
/// Contains SHA-256 hashes of embedded assets for integrity verification.
/// These hashes are calculated at build time from the source files.
/// </summary>
internal static class AssetHashes
{
	/// <summary>
	/// Maps asset filenames to their corresponding SHA-256 hashes for integrity verification.
	/// The hashes are generated at build time from the source asset files.
	/// </summary>
	internal static readonly FrozenDictionary<string, string> EmbeddedAssetHashes = new Dictionary<string, string>()
	{
		["index.html"] = "$(IndexHtmlHash)",
		["mermaid.min.js"] = "$(MermaidJsHash)",
		["js-yaml.min.js"] = "$(JsYamlHash)",
		["mermaid-layout-elk.esm.min.mjs"] = "$(MermaidElkLayoutHash)",
		["chunk-SP2CHFBE.mjs"] = "$(MermaidElkLayoutChunkSP2CHFBEHash)",
		["render-AVRWSH4D.mjs"] = "$(MermaidElkLayoutChunkRenderAVRWSH4DHash)",
	}.ToFrozenDictionary(StringComparer.OrdinalIgnoreCase);

	/// <summary>
	/// Verifies if the provided hash matches the expected hash for the given asset.
	/// </summary>
	internal static bool VerifyHash(string assetName, string actualHash)
	{
		return EmbeddedAssetHashes.TryGetValue(assetName, out var expectedHash) &&
				string.Equals(expectedHash, actualHash);
	}
}
]]>
				</Text>
			</AssetHashFile>
		</ItemGroup>

		<!-- Atomically write the file: write temp then move into place -->
		<WriteLinesToFile Encoding="utf-8" File="$(AssetHashesTempFile)" Lines="@(AssetHashFile->'%(Text)')" Overwrite="true" ContinueOnError="false" />
		<Move SourceFiles="$(AssetHashesTempFile)" DestinationFiles="$(AssetHashesFile)" OverwriteReadOnlyFiles="true" ContinueOnError="false" />

		<Message Importance="high" Text="Generated asset hashes file: $(AssetHashesFile)" />

		<!-- IMPORTANT: add the generated file to the Compile item list at execution time
		     Only add the obj-generated file if a repo-root Generated/AssetHashes.cs does NOT already exist.
		     This avoids duplicating the SDK's implicit Compile item for repo/Generated/AssetHashes.cs. -->
		<ItemGroup Condition="!Exists('$(AssetHashesFileRepoPath)')">
			<Compile Include="$(AssetHashesFile)" />
		</ItemGroup>

		<!-- Quick content validation to fail early with a clear message if generation produced an unexpected file -->
		<Error Condition="!Exists('$(AssetHashesFile)')" Text="Asset hash generation failed: generated file not found: $(AssetHashesFile)" />

		<PropertyGroup Condition="Exists('$(AssetHashesFile)')">
			<GeneratedContent>$([System.IO.File]::ReadAllText('$(AssetHashesFile)'))</GeneratedContent>
		</PropertyGroup>

		<Error Condition="!$(GeneratedContent.Contains('internal static class AssetHashes'))" Text="Asset hash generation failed: expected token 'internal static class AssetHashes' not found in $(AssetHashesFile)." />
		<Error Condition="!$(GeneratedContent.Contains('namespace MermaidPad.Generated'))" Text="Asset hash generation failed: expected namespace 'MermaidPad.Generated' not found in $(AssetHashesFile)." />
	</Target>

	<!-- Clean up generated files -->
	<Target Name="CleanAssetHashes" BeforeTargets="Clean">
		<!-- Remove only the known generated files (obj) and temp files; tolerate missing files -->
		<Delete Files="$(AssetHashesFile);$(AssetHashesTempFile)" TreatErrorsAsWarnings="true" />

		<!-- Repo-root: only delete AssetHashes.* files (do NOT sweep the entire Generated folder; preserve placeholder file) -->
		<ItemGroup Condition="Exists('$(GeneratedRepoDir)')">
			<FilesToDeleteRepo Include="$(GeneratedRepoDir)/AssetHashes*.cs" />
			<FilesToDeleteRepo Include="$(GeneratedRepoDir)/AssetHashes*.tmp" />
		</ItemGroup>
		<Delete Files="@(FilesToDeleteRepo)" Condition="Exists('$(GeneratedRepoDir)')" TreatErrorsAsWarnings="true" />
	</Target>
</Project>

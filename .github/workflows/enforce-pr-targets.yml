# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Enforce PR Target Branch Policy

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read

jobs:
  enforce-branch-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository (full history)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Validate pull request branch rules
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail

          echo "ðŸ” Validating pull request"
          echo "   Base branch: $BASE_REF"
          echo "   Head branch: $HEAD_REF"

          #
          # Rule 1: Only develop -> main is allowed
          #
          if [[ "$BASE_REF" == "main" && "$HEAD_REF" != "develop" ]]; then
            echo "::error title=Invalid PR Target::Pull requests to 'main' are only allowed from 'develop'."
            echo "âž¡ Feature branches must merge into 'develop' first."
            exit 1
          fi

          #
          # Rule 2: Never allow main -> develop
          #
          if [[ "$BASE_REF" == "develop" && "$HEAD_REF" == "main" ]]; then
            echo "::error title=Invalid PR Direction::Pull requests from 'main' into 'develop' are not allowed."
            exit 1
          fi

          #
          # Rule 3: develop must contain main (rebase required)
          #
          if [[ "$BASE_REF" == "main" && "$HEAD_REF" == "develop" ]]; then
            echo "ðŸ”Ž Verifying that 'develop' contains 'main'..."

            set +e
            git fetch origin main develop
            FETCH_RESULT=$?
            set -e

            if [[ $FETCH_RESULT -ne 0 ]]; then
              echo "::error title=Git Fetch Failed::Failed to fetch 'main' and 'develop' from origin."
              echo "âž¡ This is a CI or repository issue, not a policy violation."
              echo "âž¡ Please retry. If the issue persists, check branch existence and network status."
              exit $FETCH_RESULT
            fi

            set +e
            git merge-base --is-ancestor origin/main origin/develop
            RESULT=$?
            set -e

            if [[ $RESULT -eq 1 ]]; then
              echo "::error title=Rebase Required::'develop' does not contain the latest commits from 'main'."
              echo "âž¡ Please rebase before opening this PR:"
              echo "   git checkout develop"
              echo "   git fetch origin"
              echo "   git rebase origin/main"
              exit 1
            elif [[ $RESULT -ne 0 ]]; then
              echo "::error title=Branch Validation Failed::Unable to verify branch ancestry due to a git error."
              echo "âž¡ Please retry. If the problem persists, check repository integrity or CI logs."
              exit 1
            fi
          fi

          echo "âœ… Branch policy checks passed."
